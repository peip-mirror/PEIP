<?xml version="1.0" encoding="UTF-8"?>
<config>
	
	<plugin class="PEIP_Gearman_Context_Plugin"/>
	
	<publish_subscribe_channel id="orders"/>

	<publish_subscribe_channel id="preparedDrinks"/>

    	<channel id="coldDrinks"/>

    	<channel id="hotDrinks"/>
	
    	<channel id="deliveries"/>
	
	<gateway id="CafeGateway" 
		class="CafeGateway" 
		default_request_channel="orders" 
		default_reply_channel="deliveries"/>

	<wiretap 
		id="acceptedOrders" 
		input_channel="orders"/>

	<splitter 
		id="OrderSplitter" 
		input_channel="orders" 
		class="OrderSplitter"/>

	<gearman_client id="GearmanClient">
		<server name="localhost"/>
	</gearman_client>

    <gearman_client_activator 
		id="Gearman_Client_Activator" 
		input_channel="OrderSplitter" 
		output_channel="preparedDrinks" 
		client="GearmanClient" 
		task="cafe_channel"/>

    <aggregator 
		id="DrinkAggregator" 
		input_channel="preparedDrinks" 
		class="DrinkAggregator"/>

    <service id="waiter" class="Waiter"/>

    <service_activator 
		input_channel="DrinkAggregator" 
		ref="waiter"
              method="prepareDelivery" 
		output_channel="deliveries"/>  

    <service_activator 
		input_channel="acceptedOrders" 
		ref="DrinkAggregator"
              method="receiveOrder"/>   
</config>
